@page "/mix/{Id:int?}"

@using Downgrooves.Domain
@using Downgrooves.Admin.ViewModels
@using Downgrooves.Admin.Controls
@using Newtonsoft.Json
@using System.IO
@using System.Net

@inherits MixDetailModel



<Breadcrumbs Crumbs="@BreadcrumbItems"/>

<EditForm Model="@MixViewModel" OnValidSubmit="Save">
    <DataAnnotationsValidator/>
    <ValidationSummary/>
    <div class="row">
        <div class="col-4">
            @if (!string.IsNullOrWhiteSpace(MixViewModel.ArtworkUrl))
            {
                <div class="pb-3">
                    <section class="hover-bg">
                        
                        <button type="button" onclick="@(() => DeleteImage())" class="invisible-button">
                            <div class="hover-text">
                                <i class="fas fa-trash-alt" data-fa-transform="grow-60"></i>
                                <h4>Delete</h4>
                            </div>
                            <img src="@MixViewModel.ArtworkUrl" class="img-fluid border border-dark">                            
                        </button>
                    </section>
                </div>
            }
            else
            {
                <div class="uploadControls">
                <InputFile id="fileUpload" OnChange="OnImageInputFileChange" />    
                <button type="button" onclick="@(() => UploadImage())">Upload Image</button>
                </div>
            }
        </div>
        <div class="col-8">
            <div class="form-group">
                <label>Title:</label>
                <InputText @bind-Value="MixViewModel.Title" class="form-control" />
            </div>
            <div class="form-group">
                <label>Artist:</label>
                <InputText @bind-Value="MixViewModel.Artist" class="form-control" />
            </div>
            <div class="row">
                <div class="col-4">
                    <div class="form-group">
                        <label>Category:</label>
                        <InputText @bind-Value="MixViewModel.Category" class="form-control" />
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label>Genre:</label>
                        @if (MixViewModel.Genre != null)
                        {
                            <GenreSelector SelectedValue="MixViewModel.Genre.Id"/>
                        }
                    </div>
                </div>
                
            </div>
            <div class="row">
                <div class="col-4">
                    <div class="form-group">
                        <label>Length:</label>
                        <InputText @bind-Value="MixViewModel.Length" class="form-control" />
                    </div>
                </div>
                <div class="col-4">
                    <div class="form-group">
                        <label>Create Date:</label>
                        <input type="date" @bind="MixViewModel.CreateDate" class="form-control" />
                    </div>
                </div>
                <div class="col-1">
                    <div class="form-group">
                        <label>Show:</label>
                        <InputCheckbox @bind-Value="MixViewModel.Show" class="form-control"/>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-group">
        <label>Audio:</label>
        @if (!string.IsNullOrWhiteSpace(MixViewModel.AudioUrl))
        {
            <div class="row">
                <div class="col-11">
                    <audio controls src="@MixViewModel.AudioUrl" style="width: 100%"/>    
                </div>
                <div class="col-1">
                    <button type="button" class="btn btn-danger mt-2" onclick="@(() => DeleteAudio())"><i class="fas fa-trash-alt" data-fa-transform="grow-6"></i></button>
                </div>
            </div>           
        } else
        {
            <div class="">
                <InputFile id="fileUpload" OnChange="OnAudioInputFileChange" disabled="@_uploading" />  
                @* Show the value of the _uploaded variable divided to 1024 to show the amount in KB and also we use _fileStream?.Length / 1024 to show the total amount of KBs  *@
                <p>@(_uploadedBytes / 1024)KB / @(_fileStream?.Length / 1024)KB</p>
                @* Show the percentage of uploaded amount of of the total *@
                <p>Percentage: @_percentage %</p>
                <button type="button" onclick="@(() => UploadAudio())">Upload Audio</button>
            </div>
        }
    </div>
    <div class="form-group">
        <label>Short Description:</label>
        <InputText @bind-Value="MixViewModel.ShortDescription" class="form-control" />
    </div>
    <div class="form-group">
        <label>Description:</label>
        <InputTextArea @bind-Value="MixViewModel.Description" class="form-control" rows="3" />
    </div>
    <div class="row">
        <div class="col-6">
            <div class="py-2">
                <button class="btn btn-danger" @onclick="Delete">Delete Record</button>
            </div>
        </div>
        <div class="col-6">
            <div class="float-right py-3">
                <NavLink class="btn btn-outline-light" href="/releases">Cancel</NavLink>
                <button class="btn btn-primary" type="submit">Save</button>
            </div>
        </div>
    </div>
    <div class="clearfix"></div>
</EditForm>
@if (!IsNew && MixViewModel.Tracks != null && MixViewModel.Tracks.Any())
{
    <hr class="w-100"/>
    <h4>Tracks</h4>        
    <table class="table table-striped table-active w-100">
        <thead class="thead-dark">
        <tr>
            <th scope="col">#</th>
            <th scope="col">Artist</th>
            <th scope="col">Track Name</th>
            <th scope="col">Label</th>
            <th></th>
        </tr>
        </thead>
        <tbody>
    @foreach (var track in MixViewModel?.Tracks.OrderBy(x => x.Number))
        {
            <tr>
                <th scope="row">@track.Number</th>
                <td>@track.Artist</td>
                <td>@track.Title</td>
                <td>@track.Label</td>
                <td>
                    <div class="float-right">
                    <NavLink class="btn btn-light btn-sm" href="@($"/mix/{MixViewModel.MixId}/track/{track.Id}")"><i class="fa fa-pencil"></i></NavLink>
                    <button class="btn btn-danger btn-sm" onclick="@(() => DeleteTrack(track.Id))"><i class="fa fa-trash"></i></button>
                    </div>
                </td>
            </tr>
        }
        </tbody>
        </table>
        <EditForm Model="@MixTrackViewModel" OnValidSubmit="AddTrack">
        <input type="hidden" id="MixId" @bind="MixViewModel.MixId" />
        <div class="row">
            <div class="col-1">
                <div class="form-group">
                    <label>#:</label>
                    <InputNumber @bind-Value="MixTrackViewModel.Number" class="form-control" />
                </div>
            </div>
            <div class="col-3">
                <div class="form-group">
                    <label>Artist:</label>
                    <InputText @bind-Value="MixTrackViewModel.Artist" class="form-control" />
                </div>
            </div>
            <div class="col-3">
                <div class="form-group">
                    <label>Title:</label>
                    <InputText @bind-Value="MixTrackViewModel.Title" class="form-control" />
                </div>
            </div>
            <div class="col-3">
                <div class="form-group">
                    <label>Remix (optional):</label>
                    <InputText @bind-Value="MixTrackViewModel.Remix" class="form-control" />
                </div>
            </div>
            <div class="col-2">
                <div class="form-group">
                    <label>Label:</label>
                    <InputText @bind-Value="MixTrackViewModel.Label" class="form-control" />
                </div>
            </div>
        </div>
        <div class="float-right py-2">
            <button class="btn btn-sm btn-dark" type="submit">Add Track</button>
        </div>
        </EditForm>
}